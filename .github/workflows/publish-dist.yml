name: publish-dist
on:
  workflow_run:
    workflows: build-dist
    types: [completed]

jobs:
  run:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Download build-dist artifacts
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist
          workflow: build-dist
          run_id: ${{ github.event.workflow_run.id }}

      - name: Set up configuration and secrets
        run: |
          printf '[user]\n\tname = Cockpit Project\n\temail=cockpituous@gmail.com\n' > ~/.gitconfig
          echo '${{ secrets.COCKPITUOUS_TOKEN }}' > ~/.config/github-token
          # we push to -dist repo via https://github.com, that needs our cockpituous token
          git config --global credential.helper store
          echo 'https://token:${{ secrets.COCKPITUOUS_TOKEN }}@github.com' >> ~/.git-credentials

      - name: Commit to dist repo
        run: |
          set -ex
          SHA=$(cat SHA)

          # multiple parallel workflows race against each other, so the final
          # `git push` may fail
          rc=1
          for retry in $(seq 5); do
              git clone https://github.com/${{ github.repository }}-dist.git dist-repo
              rm -rf dist-repo/dist
              cp -r dist/ package-lock.json dist-repo/

              # freshly created empty repo?
              cd dist-repo
              git rev-parse HEAD >/dev/null 2>&1 || git init -b main

              # commit the updated files
              git add .
              # may have no changes
              git diff --cached --quiet || git commit -m "Build for $SHA"
              tag="sha-$SHA"
              git tag $tag

              # push commit and tag
              if git push origin HEAD $tag; then
                  rc=0
                  break
              else
                  echo "ERROR: conflict? Retrying git commit"
                  git push origin :$tag || true
                  cd ..
                  rm -rf dist-repo
              fi
          done
          exit $rc

      - name: Trigger integration tests for PRs
        run: |
          if ! grep -q '"pull_request"' event.json; then
              echo "build-dist event was not a pull request"
              exit 0
          fi
          # support running this from forks
          if [ -z '${{ secrets.AMQP_CLIENT_KEY }}' ]; then
              echo "No AMQP secrets, skipping tests-scan"
              exit 0
          fi

          pip install pika

          git clone --depth=1 https://github.com/cockpit-project/bots

          # tests-scan does not currently have a --secrets-dir option
          sudo mkdir -p /run/secrets/webhook
          echo '${{ secrets.COCKPIT_CA_PEM }}' | sudo dd status=none of=/run/secrets/webhook/ca.pem
          echo '${{ secrets.AMQP_CLIENT_PEM }}' | sudo dd status=none of=/run/secrets/webhook/amqp-client.pem
          echo '${{ secrets.AMQP_CLIENT_KEY }}' | sudo dd status=none of=/run/secrets/webhook/amqp-client.key

          # FIXME: make this nicer in tests-scan
          AMQP_SERVER=$(PYTHONPATH=bots python3 -c 'from task.distributed_queue import *; print(DEFAULT_AMQP_SERVER)')
          GITHUB_BASE=${{ github.repository }} bots/tests-scan -d --pull-data "$(cat event.json)" --amqp "$AMQP_SERVER"
